---
author: CC-2018
layout: post
title: "flask源码"
date: 2017-06-29 10:09:01 +0800
categories: document
tag: 总结
---

* content
{:toc}

### wsgi

WSGI接口定义非常简单，它只要求Web开发者实现一个函数，就可以响应HTTP请求。

```
def application(environ, start_response):
    start_response('200 OK', [('Content-Type', 'text/html')])
    return '<h1>Hello, web!</h1>'
```
上面的application()函数就是符合WSGI标准的一个HTTP处理函数，它接收两个参数：
environ：一个包含所有HTTP请求信息的dict对象；
start_response：一个发送HTTP响应的函数。

再启动WSGI服务器，去加载application，整个最简单的web应用就建立起来了

### werkzeug local

**local**

Local 是个线程局部对象，里面有个`__storage__`: `storage[ident][name] = value`, ident为线程或协程id

实现`__getattr__`, `__setattr__`, `__delattr__`, 好让dict里的k-v能通过'.'调用

实现`__call__`，通过类似函数调用生成LocalProxy代理

**LocalStack**

封装了`local`，不过local内只有一个叫`stack`的k-v，其value是list，所以能实现push，pop，top

而pop到最后一个元素时，会把local dict里面的stack对象给pop掉，等push时重新创建

flask 里面的这个list存放的是object，object又有一些属性数据


```
_request_ctx_stack = LocalStack()
_app_ctx_stack = LocalStack()
```

### config

config模块本质上是一个dict，存储一些k-v，支持多种加载模式：
1：从py文件加载，用types创建一个临时模块config，解析py字节流，将全局变量存储到config模块的__dict__里
2：从模块加载：用dir获取模块的属性，如果是大写的就存储到dict里面
3：from_object，也可以提供模块名称，这样会先import模块，再解析模块属性
